PM33 Zero-Downtime Deployment Pipeline ## ðŸš€ Overview PM33's production deployment pipeline provides enterprise-grade zero-downtime deployments with automatic rollback capabilities, comprehensive health monitoring, and multi-environment support. ## ðŸ—ï¸ Architecture ### Core Components 1. **Railway Platform Integration** - Blue-green deployments with health checks 2. **Database Migration System** - Zero-downtime schema changes with rollback 3. **Health Monitoring Service** - Comprehensive system health validation 4. **Automatic Rollback System** - Intelligent failure detection and recovery 5. **Environment Management** - Configuration validation across environments 6. **Observability Integration** - Sentry error tracking and PostHog analytics ### File Structure ``` scripts/ â”œâ”€â”€ orchestrate-deployment.sh # Main deployment orchestration â”œâ”€â”€ deploy.py # Zero-downtime deployment automation â”œâ”€â”€ rollback.py # Automatic rollback system â””â”€â”€ validate-env.py # Environment validation app/backend/ â”œâ”€â”€ config/environment.py # Environment configuration management â”œâ”€â”€ health.py # Health check service â”œâ”€â”€ monitoring/observability.py # Comprehensive monitoring â””â”€â”€ migrations/ # Database migration system â”œâ”€â”€ alembic.ini # Alembic configuration â”œâ”€â”€ env.py # Migration environment â””â”€â”€ migration_manager.py # Migration orchestration railway.toml # Railway deployment configuration ``` ## ðŸš¦ Quick Start ### Prerequisites ```bash # Install dependencies npm install -g @railway/cli pip install -r requirements.txt # Authenticate with Railway railway login # Validate environment ./scripts/validate-env.py --environment production ``` ### Basic Deployment ```bash # Deploy to staging ./scripts/orchestrate-deployment.sh --environment staging # Deploy to production with migrations ./scripts/orchestrate-deployment.sh --environment production --migrate # Deploy specific branch ./scripts/orchestrate-deployment.sh --environment production --branch feature/new-release ``` ## ðŸŽ›ï¸ Deployment Commands ### Orchestration Script The main deployment orchestration script provides a complete deployment pipeline: ```bash ./scripts/orchestrate-deployment.sh [OPTIONS] Options: -e, --environment ENV Target environment (development|staging|production) -b, --branch BRANCH Git branch to deploy (default: current branch) -m, --migrate Run database migrations --no-monitor Skip deployment monitoring --no-rollback Disable automatic rollback on failure --help Show help message Examples: ./scripts/orchestrate-deployment.sh --environment production --migrate ./scripts/orchestrate-deployment.sh --environment staging --branch feature/ui-updates ENVIRONMENT=production MIGRATION_REQUIRED=true ./scripts/orchestrate-deployment.sh ``` ### Direct Python Scripts For advanced use cases, you can use the Python scripts directly: ```bash # Deploy with custom settings python3 scripts/deploy.py --environment production --migrate --commit abc123 # Manual rollback python3 scripts/rollback.py --environment production --reason user_initiated # Start deployment monitoring python3 scripts/rollback.py --environment production --monitor # Environment validation python3 scripts/validate-env.py --environment production --verbose ``` ## ðŸ”§ Environment Configuration ### Required Environment Variables #### Database ```bash DATABASE_URL="postgresql+asyncpg://user:pass@host/db" DB_POOL_SIZE=20 DB_SSL_REQUIRE=true ``` #### AI Services ```bash ANTHROPIC_API_KEY="sk-ant-..." OPENAI_API_KEY="sk-..." TOGETHER_API_KEY="..." ``` #### Vector Database ```bash PINECONE_API_KEY="..." PINECONE_ENVIRONMENT="us-west1-gcp-free" PINECONE_INDEX="pm33-production" ``` #### External Services ```bash SUPABASE_URL="https://..." SUPABASE_ANON_KEY="..." SUPABASE_SERVICE_ROLE_KEY="..." RESEND_API_KEY="re_..." STRIPE_SECRET_KEY="sk_..." STRIPE_PUBLISHABLE_KEY="pk_..." STRIPE_WEBHOOK_SECRET="whsec_..." ``` #### Monitoring ```bash SENTRY_DSN="https://..." POSTHOG_PROJECT_API_KEY="phc_..." PM33_SLACK_WEBHOOK="https://hooks.slack.com/..." ``` #### Security ```bash SECRET_KEY="your-secret-key-32-chars-minimum" JWT_SECRET="your-jwt-secret-32-chars-minimum" ``` ### Environment-Specific Settings #### Production - All monitoring services required - SSL enforced for database - Debug disabled - Rate limiting enabled - Allowed hosts configured #### Staging - Monitoring recommended for testing - Relaxed security settings - Debug optional #### Development - Minimal requirements - Debug enabled - Local services allowed ## ðŸ¥ Health Checks The health check system monitors all critical components: ### Core Health Checks - âœ… Application status and readiness - âœ… Database connectivity and performance - âœ… AI services configuration - âœ… Monitoring services status ### Detailed Health Checks - ðŸ” Vector database connectivity - ðŸ” External services integration - ðŸ” System resource utilization - ðŸ” Cache systems status ### Health Check Endpoints ```bash # Basic health check (fast) curl https://your-app.railway.app/api/health # Detailed health check (comprehensive) curl https://your-app.railway.app/api/health/detailed ``` ## ðŸ”„ Rollback System ### Automatic Rollback The system automatically rolls back when: - Health checks fail consistently - Deployment process encounters errors - Database migrations fail - Critical services become unavailable ### Manual Rollback ```bash # Rollback to specific deployment python3 scripts/rollback.py --target deployment-id-12345 # Emergency rollback to last known good python3 scripts/rollback.py --reason emergency --strategy immediate # Graceful rollback with request completion python3 scripts/rollback.py --strategy graceful ``` ### Rollback Monitoring ```bash # Start monitoring with automatic rollback python3 scripts/rollback.py --monitor --failure-threshold 3 # Monitor with custom intervals python3 scripts/rollback.py --monitor --monitor-interval 60 --failure-threshold 2 ``` ## ðŸ“Š Monitoring & Observability ### Integrated Services 1. **Sentry** - Error tracking and performance monitoring 2. **PostHog** - Product analytics and user behavior tracking 3. **Railway** - Infrastructure monitoring and logs 4. **Custom Health Checks** - Application-specific monitoring ### Deployment Metrics - Deployment duration and success rate - Health check response times - Rollback frequency and reasons - Service availability during deployments ### Alerts & Notifications - Slack notifications for deployment events - Sentry alerts for errors and performance issues - PostHog insights for user impact analysis - Railway infrastructure alerts ## ðŸ›¡ï¸ Security Features ### Deployment Security - Environment variable validation - SSL/TLS enforcement - Rate limiting and DDoS protection - Secure secret management ### Access Control - Railway project-level permissions - Environment-specific access controls - Audit logging for deployment actions - Secure API key rotation ## ðŸ“‹ Best Practices ### Pre-Deployment 1. Run comprehensive tests locally 2. Validate environment configuration 3. Review database migration plans 4. Ensure monitoring is operational ### During Deployment 1. Monitor health checks continuously 2. Watch for error spikes in Sentry 3. Verify user traffic patterns in PostHog 4. Keep rollback option ready ### Post-Deployment 1. Verify all services are healthy 2. Check performance metrics 3. Monitor error rates for 30 minutes 4. Update deployment documentation ## ðŸš¨ Troubleshooting ### Common Issues #### Deployment Fails ```bash # Check environment validation ./scripts/validate-env.py --environment production --verbose # Verify Railway authentication railway whoami # Check current deployment status railway status --environment production ``` #### Health Checks Fail ```bash # Run manual health check python3 -c " import asyncio from app.backend.health import get_health result = asyncio.run(get_health(detailed=True)) print(result.to_dict()) " # Check service connectivity python3 scripts/validate-env.py --environment production ``` #### Rollback Needed ```bash # Emergency rollback python3 scripts/rollback.py --reason emergency --strategy immediate # Check rollback status railway logs --environment production ``` ### Debug Commands ```bash # Check deployment history railway deployments --environment production # View real-time logs railway logs --environment production --follow # Check environment variables railway variables --environment production # Test database connection python3 -c " from app.backend.config.environment import get_config config = get_config() print(f'Database URL configured: {bool(config.database.url)}') " ``` ## ðŸ“ˆ Performance Optimization ### Deployment Speed - Parallel health checks - Optimized Docker builds - Efficient migration strategies - Smart rollback decisions ### Resource Usage - Connection pooling for database - AI service rate limiting - Memory-efficient health checks - Background monitoring processes ### Scalability - Multi-environment support - Horizontal scaling ready - Load balancer integration - CDN optimization ## ðŸ”® Advanced Features ### Blue-Green Deployments Configured in `railway.toml` for zero-downtime deployments with automatic traffic switching. ### Migration Rollbacks Database schema changes can be rolled back automatically if deployment fails. ### Multi-AI Orchestration Health checks validate all AI services (Anthropic, OpenAI, Together AI) are operational. ### Intelligent Monitoring PostHog integration provides deployment impact analysis on user behavior. ### Custom Health Checks Extensible health check system for application-specific validation. --- ## ðŸ†˜ Support For deployment issues: 1. **Check Logs**: `railway logs --environment production --follow` 2. **Validate Environment**: `./scripts/validate-env.py --verbose` 3. **Health Status**: Visit `/api/health/detailed` endpoint 4. **Emergency Rollback**: `python3 scripts/rollback.py --reason emergency` 5. **Team Notifications**: Check PM33 Slack webhook for alerts --- *This deployment pipeline ensures PM33 maintains 99.9% uptime while enabling rapid, safe deployments to production.*